<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KASC Risk Predictions</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Ganesha025/Office@main/styles.css">
<!-- <script src="https://cdn.jsdelivr.net/gh/Ganesha025/Office@main/valid.js"></script> -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
    ::-webkit-scrollbar {
    display: none;
}main{
    padding: 60px;
    padding-top: 0;
    
}*{
     font-family: 'Poppins', sans-serif ;
     /* user-select: none; */
     font-size: 16px;
}

body{
    background-color: #FAFAFA;
}header{
    background-color: white;
}#sample_card{
    box-shadow: rgba(0, 0, 0, 0.07) 0px 1px 2px, rgba(0, 0, 0, 0.07) 0px 2px 4px, rgba(0, 0, 0, 0.07) 0px 4px 8px, rgba(0, 0, 0, 0.07) 0px 8px 16px, rgba(0, 0, 0, 0.07) 0px 16px 32px, rgba(0, 0, 0, 0.07) 0px 32px 64px;
}#sample_Charts div{
    box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
}#riskTable{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
#riskTable thead th{background:#1e35a3;color:#fff;font-weight:600;padding:12px 10px;border-bottom:2px solid #e5e7eb;white-space:nowrap;text-align:left}
#riskTable tbody td{padding:10px;border-bottom:1px solid #e5e7eb;color:#374151;font-size:14px}
#riskTable tbody tr:nth-child(even){background:#f9fafb}
#riskTable tbody tr:hover{background:#eef2ff;transition:.2s}
.low{color:#15803d;font-weight:600}
.medium{color:#ca8a04;font-weight:600}
.high{color:#dc2626;font-weight:700}
.dataTables_filter input,.dataTables_length select{border:1px solid #d1d5db;border-radius:6px;padding:6px 10px;outline:0}
.dataTables_filter input:focus{border-color:#1e35a3}
.dataTables_paginate .paginate_button{padding:6px 12px;margin:2px;border-radius:6px;border:1px solid #d1d5db;background:#fff;color:#1e35a3!important}
.dataTables_paginate .paginate_button:hover,.dataTables_paginate .paginate_button.current{background:#1e35a3!important;color:#fff!important;border-color:#1e35a3}
.dataTables_info{color:#4b5563;font-size:14px;margin-top:10px}
  #formAddStudent label{display:block;margin-bottom:0.25rem;font-weight:500}
  #formAddStudent input,#formAddStudent select{width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:0.25rem}
  #formAddStudent input:focus,#formAddStudent select:focus{outline:none;border-color:#1e35a3;box-shadow:0 0 0 2px rgba(30,53,163,0.3)}
  .text-red-500{color:#f56565}
   #studentList::-webkit-scrollbar {
    width: 5px;  /* vertical scrollbar width */
 /* horizontal scrollbar height */
    display: block;
}.chart-card {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    border-radius: 20px;
    background: white;
}


#studentList::-webkit-scrollbar-thumb {
    background-color: #c1c1c1;
    border-radius: 6px;
}

#studentList::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1);
    border-radius: 6px;
}

</style>
</head>
<body>
<header class="sticky top-0 z-50 bg-white border-b">
    <div class="max-w-full flex items-center px-10">
    <div class="flex items-center justify-between w-full h-20">

      <!-- Left group: Logo + Brand + all nav links -->
      <div class="flex items-center space-x-8">
<div class="flex items-center space-x-4"> 
    <img src="https://portal.kongunaducollege.ac.in//uploads/banner/logo.png" alt="Logo" class="h-12 w-auto"> 
    <span class="text-xl sm:text-2xl font-bold text-[#1e35a3] tracking-wide"> KASC </span>
 </div>
<nav class="flex space-x-8 font-semibold text-base">
  <a href="#" class="text-orange-500 text-lg">Dashboard</a> <!-- active -->
  <a href="#" class="text-gray-400 text-lg hover:text-[#1e35a3] hover:underline transition">
    Students
  </a>
  <a href="#" class="text-gray-400 text-lg hover:text-[#1e35a3] hover:underline transition">
    Staffs
  </a>
</nav>

      </div>

      <!-- Right group: Search + Settings + Notifications + Profile -->
      <div class="flex items-center space-x-6">

        <!-- Search -->
        <div class="hidden sm:flex items-center border border-[#1e35a3]/40 rounded-full px-3 h-10">
          <span class="material-symbols-outlined text-[#1e35a3] text-lg">
            search
          </span>
          <input
            type="text"
            placeholder="Search..."
            class="ml-2 w-36 md:w-48 bg-transparent outline-none
                   text-sm text-[#1e35a3] placeholder-[#1e35a3]/60">
        </div>

        <!-- Settings Icon -->
        <button class="relative w-10 h-10 rounded-full
                       flex items-center justify-center
                       hover:bg-[#f5f7ff] transition">
          <span class="material-symbols-outlined text-[#1e35a3]"
                style="font-variation-settings: 'wght' 300;">
            settings
          </span>
        </button>

        <!-- Notifications with Orange Dot -->
        <button class="relative w-10 h-10 rounded-full
                       flex items-center justify-center
                       hover:bg-[#f5f7ff] transition">
          <span class="material-symbols-outlined text-[#1e35a3]"
                style="font-variation-settings: 'wght' 300;">
            notifications
          </span>
          <span class="absolute top-2 right-2 w-2.5 h-2.5
                       bg-orange-500 rounded-full
                       ring-2 ring-white"></span>
        </button>

        <!-- Profile Icon -->
        <div class="relative">
          <button
            id="accountBtn"
            class="relative flex items-center justify-center
                   w-10 h-10 sm:w-10 sm:h-10
                   rounded-full overflow-hidden
                   border-2 border-[#1e35a3]
                   bg-white
                   transition-all duration-200
                   hover:bg-[#f5f7ff]
                   hover:scale-105
                   active:scale-95
                   focus:outline-none
                   focus:ring-2 focus:ring-[#1e35a3]/40">

            <span
              class="material-symbols-outlined absolute inset-0
                     flex items-center justify-center
                     text-[1.6rem] sm:text-[2.1rem]
                     leading-none text-[#1e35a3]"
              style="font-variation-settings: 'wght' 300;">
              person
            </span>
          </button>

          <!-- Dropdown -->
          <div id="accountDropdown"
               class="hidden absolute right-0 mt-3 w-44
                      bg-white text-[#1e35a3]
                      rounded-lg shadow-lg z-50">
            <a href="#" class="block px-4 py-2 hover:bg-gray-100 font-semibold">
              Profile
            </a>
            <a href="#" class="block px-4 py-2 hover:bg-gray-100 font-semibold">
              Settings
            </a>
            <form method="POST" action="/logout">
              <button type="submit"
                      class="w-full text-left px-4 py-2 hover:bg-gray-100 font-semibold">
                Logout
              </button>
            </form>
          </div>
        </div>

      </div>

    </div>
  </div>
</header>

<!-- <div class="flex justify-end mt-5"> -->
  <div class="container mx-auto flex justify-end px-10 py-4 ">
    <a href="#" class="px-4 py-2 bg-[#0c2357] text-white rounded-[25px] " id="openModalBtn">
    Add Student
  </a>
  </div>

<script>
const b=document.getElementById('accountBtn'),d=document.getElementById('accountDropdown');
b.onclick=()=>d.classList.toggle('hidden');
document.onclick=e=>{if(!b.contains(e.target)&&!d.contains(e.target))d.classList.add('hidden')};
</script>

<main>
     <div id="toast"
     class="fixed top-6 right-6 z-50 hidden px-4 py-3 rounded-lg shadow-lg text-white transition-all duration-300">
    <span id="toastMsg"></span>
</div>
<script>
function showToast(msg, type='success'){
    const toast = document.getElementById('toast');
    const text  = document.getElementById('toastMsg');

    toast.classList.remove('hidden','bg-green-600','bg-red-600','bg-yellow-600');
    toast.classList.add(type==='success'?'bg-green-600':type==='error'?'bg-red-600':'bg-yellow-600');

    text.textContent = msg;

    setTimeout(()=> toast.classList.add('opacity-0'), 2500);
    setTimeout(()=>{
        toast.classList.add('hidden');
        toast.classList.remove('opacity-0');
    },3000);
}
</script>
<?php
$totalStudents = array_sum(array_column($students_by_department, 'total'));

$topDept = $topCount = 0;
foreach ($dropout_by_department as $d) {
    if ($d['total'] > $topCount) {
        $topCount = $d['total'];
        $topDept  = $d['department_name'];
    }
}

$cards = [
    [
        'title'  => 'Total Risk Students',
        'value'  => $totalStudents,
        'sub'    => 'All',
        'border' => 'border-blue-500',
        'text'   => 'text-blue-600'
    ]
];

/* HIGH first */
foreach ($lowHigh as $i) {
    if ($i['risk_level'] === 'HIGH') {
        $cards[] = [
            'title'  => 'High Risk',
            'value'  => $i['COUNT(*)'],
            'sub'    => 'Students',
            'border' => 'border-red-500',
            'text'   => 'text-red-600'
        ];
    }
}

/* MEDIUM second */
foreach ($lowHigh as $i) {
    if ($i['risk_level'] === 'MEDIUM') {
        $cards[] = [
            'title'  => 'Medium Risk',
            'value'  => $i['COUNT(*)'],
            'sub'    => 'Students',
            'border' => 'border-yellow-400',
            'text'   => 'text-yellow-500'
        ];
    }
}

/* Department last */
$cards[] = [
    'title'  => 'Highest Risk Department',
    'value'  => $topCount,
    'sub'    => $topDept,
    'border' => 'border-red-600',
    'text'   => 'text-red-600'
];
?>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 bg-[#0c2357] p-5 rounded-[20px]">
<?php foreach($cards as $c): ?>
    <div class="relative group rounded-2xl p-[1px] 
        <?php
            switch($c['title']) {
        case 'Total Students':
        case 'High Risk':
        case 'Medium Risk':
        case 'Highest Risk Department':
        default:
            echo 'bg-white';
            break;
            }
        ?>
        hover:scale-[1.03] transition-all duration-300
    ">
        <div class="bg-white/80 backdrop-blur-xl rounded-2xl p-5 h-full shadow-xl flex flex-col justify-between">

            <!-- Title -->
            <h3 class="text-sm font-semibold text-[#e64b29] tracking-wide uppercase">
                <?= esc($c['title']) ?>
            </h3>

            <!-- Value -->
            <div class="mt-4 flex items-end justify-between ">
                <div>
                    <p class="text-4xl font-black text-gray-900 leading-none">
                        <?= esc($c['value']) ?>
                    </p>
                    <p class="text-sm text-gray-500 mt-1">
                        <?= esc($c['sub']) ?>
                    </p>
                </div>

                <!-- Icon bubble -->
                <div class="w-12 h-12 rounded-xl flex items-center justify-center shadow-lg 
                    <?php
                        switch($c['title']) {
                            case 'Total Students': echo 'bg-blue-500 text-white'; break;
                            case 'High Risk': echo 'bg-[#e64b29] text-white'; break;
                            case 'Medium Risk': echo 'bg-yellow-400 text-white'; break;
                            case 'Highest Risk Department': echo 'bg-red-500 text-white'; break;
                            default: echo 'bg-gray-500 text-white'; break;
                        }
                    ?>
                ">
                    <span class="material-symbols-outlined text-2xl">
                        <?php
                            switch($c['title']) {
                                case 'Total Students': echo 'groups'; break;
                                case 'High Risk': echo 'warning'; break;
                                case 'Medium Risk': echo 'report'; break;
                                case 'Highest Risk Department': echo 'apartment'; break;
                                default: echo 'info'; break;
                            }
                        ?>
                    </span>
                </div>
            </div>

        </div>
    </div>
<?php endforeach; ?>
</div>
<!-- <button id="openModalBtn" class="px-4 py-2 bg-blue-600 text-white rounded justify-end">Add Student</button> -->



<!-- Modal -->
<div id="addStudentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300 opacity-0">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative transform scale-95 transition-all duration-300 ease-in-out">
    <button id="closeAddStudentModal" class="absolute top-3 right-3 text-gray-500"><span class="material-symbols-outlined text-2xl">close</span></button>
    <h3 class="text-xl font-bold text-[#1e35a3] mb-4">Add New Student</h3>
    <form id="formAddStudent" action="Addstudent" method="post" class="grid grid-cols-2 gap-4">
      <div class="col-span-2">
        <label class="font-medium">Student Name <span class="text-red-500">*</span></label>
        <input type="text" id="inputStudentName" name="student_name" placeholder="Student Name" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-[#1e35a3]">
      </div>
      <div class="col-span-2">
        <label class="font-medium">Department <span class="text-red-500">*</span></label>
        <select id="department" class="w-full border rounded px-2 py-1" name="department_name">
            <option value="" selected>---Select---</option>
            <?php foreach($all_departments as $d): ?>
                <option value="<?= esc($d['department_name']) ?>" data-fee="<?= esc($d['department_fees_amount']) ?>">
                    <?= esc($d['department_name']) ?>
                </option>
            <?php endforeach; ?>
        </select>
      </div>
      <div class="col-span-2" id="deptFeeDisplay" class="text-gray-700 font-medium mt-1"></div>
      <div>
        <label class="font-medium">Incidents <span class="text-red-500">*</span></label>
        <input type="number" id="inputIncidents" name="incident_count" placeholder="Incidents" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-[#1e35a3]">
      </div>
      <div>
        <label class="font-medium">Internal Marks <span class="text-red-500">*</span></label>
        <input type="number" id="inputInternalMarks" name="avg_internal_marks" placeholder="Internal Marks" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-[#1e35a3]">
      </div>
      <div>
        <label class="font-medium">Attendance % <span class="text-red-500">*</span></label>
        <input type="number" id="inputAttendance" name="attendance_percentage" placeholder="Attendance %" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-[#1e35a3]">
      </div>
      <div class="col-span-2 hidden" id="paidSection">
        <label class="font-medium">Amount Paid <span class="text-red-500">*</span></label>
        <input type="number" id="paidAmount" name="paid_amount" placeholder="Enter Paid Amount" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-[#1e35a3]" min="0">
      </div>
      <div class="col-span-2 hidden" id="remainingSection">
        <label class="font-medium">Amount Remaining <span class="text-red-500">*</span></label>
        <input type="number" id="remainingAmount" name="remaining_amount" class="w-full border rounded px-3 py-2 bg-gray-100" readonly>
      </div>
      <div class="col-span-2 flex justify-end space-x-2 mt-4">
        <button type="button" id="cancelAddStudentModal" class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100">Cancel</button>
      </div>
    </form>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function(){
    function vName(n){return/^[A-Za-z\s.]*$/.test(n)&&((n.match(/\./g)||[]).length<=1)&&((n.match(/ /g)||[]).length<=2)&&n.trim()!==''}
    function vForm(){
        let s=$('#inputStudentName').val().trim(),d=$('#department').val(),i=parseInt($('#inputIncidents').val())||0,m=parseInt($('#inputInternalMarks').val())||0,a=parseInt($('#inputAttendance').val())||0,p=parseFloat($('#paidAmount').val())||0,r=parseFloat($('#remainingAmount').val())||0,f=true
        if(!vName(s)||d===''||i>10||i<0||m>50||m<0||a>100||a<0)f=false
        if($('#paidSection').is(':visible')&&(p<0||r<0))f=false
        $('#formSubmitBtn').prop('disabled',!f)
    }
    $('#formAddStudent input,#formAddStudent select').on('input change',vForm)
    $('#inputStudentName').on('keypress',function(e){let c=e.key,t=$(this).val();if(!/^[A-Za-z .]$/.test(c)||(c==='.'&&(t.match(/\./g)||[]).length>=1)||(c===' '&&(t.match(/ /g)||[]).length>=2))e.preventDefault()})
    $('#inputAttendance').on('input',function(){if(this.value>100)this.value=100})
    $('#inputIncidents').on('input',function(){if(this.value>10)this.value=10})
    $('#inputInternalMarks').on('input',function(){if(this.value>50)this.value=50})
    $('<button>',{type:'submit',id:'formSubmitBtn',class:'px-4 py-2 bg-[#1e35a3] text-white rounded hover:bg-indigo-700',text:'Submit',disabled:true}).appendTo('#formAddStudent .flex')
})
let deptSelect=document.getElementById('department'),feeDisplay=document.getElementById('deptFeeDisplay'),paidInput=document.getElementById('paidAmount'),remainingInput=document.getElementById('remainingAmount'),paidSection=document.getElementById('paidSection'),remainingSection=document.getElementById('remainingSection'),departmentFee=0
deptSelect.addEventListener('change',()=>{let o=deptSelect.options[deptSelect.selectedIndex],f=o.getAttribute('data-fee');departmentFee=f?parseFloat(f):0;if(departmentFee>0){feeDisplay.textContent=`Department Fee: ₹${departmentFee.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2})}`;paidSection.classList.remove('hidden');remainingSection.classList.remove('hidden')}else{feeDisplay.textContent='';paidSection.classList.add('hidden');remainingSection.classList.add('hidden')}paidInput.value='';remainingInput.value=''})
paidInput.addEventListener('input',()=>{let p=paidInput.value.replace(/[^0-9]/g,'');if(p==='')p='0';p=parseInt(p);if(p>departmentFee)p=departmentFee;paidInput.value=p;remainingInput.value=(departmentFee-p).toFixed(2);$('#formAddStudent input,#formAddStudent select').trigger('input')})
paidInput.addEventListener('keypress',e=>{if(e.key==='e'||e.key==='+'||e.key==='-')e.preventDefault()})
remainingInput.addEventListener('keypress',e=>false)
function numbersOnly(el, allowDecimal = false) {
    el.addEventListener('keypress', e => {
        if (['e','E','+','-'].includes(e.key)) e.preventDefault()
        if (!allowDecimal && e.key === '.') e.preventDefault()
        if (!/^\d$/.test(e.key)) e.preventDefault()
    })

    el.addEventListener('paste', e => {
        const t = (e.clipboardData || window.clipboardData).getData('text')
        if (!/^\d+$/.test(t)) e.preventDefault()
    })

    el.addEventListener('input', () => {
        el.value = el.value.replace(/\D/g, '')
    })
}
numbersOnly(document.getElementById('inputAttendance'))
numbersOnly(document.getElementById('inputIncidents'))
numbersOnly(document.getElementById('inputInternalMarks'))
numbersOnly(document.getElementById('paidAmount'))
numbersOnly(document.getElementById('remainingAmount'))

</script>
<script>
const modal=document.getElementById('addStudentModal'),content=modal.querySelector('div');
document.getElementById('openModalBtn').onclick=()=>{
    modal.classList.remove('hidden');setTimeout(()=>{
    modal.classList.remove('opacity-0');content.classList.remove('scale-95');
    content.classList.add('scale-100');modal.classList.add('flex');},10);
    document.getElementById('inputStudentName').focus();
}
function closeModal(){modal.classList.add('opacity-0');content.classList.remove('scale-100');content.classList.add('scale-95');setTimeout(()=>{modal.classList.add('hidden');modal.classList.remove('flex');},300);}
document.getElementById('closeAddStudentModal').onclick=closeModal;
document.getElementById('cancelAddStudentModal').onclick=closeModal;
modal.onclick=e=>{if(e.target===modal)closeModal();}
$('#formAddStudent').on('submit', function(e){
    e.preventDefault();

    const form = $(this);

    $.ajax({
        url: form.attr('action'),
        type: 'POST',
        data: form.serialize(),
        dataType: 'json',
        success: function(res){
            if(res.status === 'success'){
                closeModal();
                showToast(res.message || 'Student added successfully','success');
                form[0].reset();
                $('#formSubmitBtn').prop('disabled', true);
                 setTimeout(() => {
            window.location.reload(); // ✅ calls index()
        }, 1000);
            } else {
                closeModal();
                showToast(res.message || 'Something went wrong','error');
            }
        },
        error: function(){
            showToast('Server error. Try again','error');
        }
    });
});
</script>

<!--<div class="flex flex-col items-center mb-6 mt-20">
    <h2 class="text-xl font-semibold text-center">
        overAll Data
    </h2>
    <span class="mt-2 h-1 w-16 bg-[#1e35a3] rounded-full"></span>
</div>-->
<div class="container mx-auto mt-2 py-10">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 ">

        <!-- Risk Level Distribution -->
        <div class="chart-card p-4 h-[360px] sm:h-[300px] lg:h-[340px] flex flex-col">

            <h3 class="text-lg font-bold text-[#1e35a3] mb-2">
                Risk Level Distribution
            </h3>
            <div id="myPieChart" class="w-full flex-1 pb-10"></div>
        </div>

        <!-- High Risk Students by Department -->
        <div class="chart-card p-4 h-[360px] sm:h-[300px] lg:h-[340px] flex flex-col">


            <h3 class="text-lg font-bold text-[#1e35a3] mb-2">
                High Risk Student Count By Department
            </h3>
            <canvas id="deptBarChart" class="w-full flex-1 pb-5"></canvas>
        </div>

        <!-- Incident Analysis -->
      <div class="chart-card p-4 h-[360px] sm:h-[300px] lg:h-[340px] flex flex-col">


            <h3 class="text-lg font-bold text-[#1e35a3] mb-2">
                Incident Analysis By Department
            </h3>
            <canvas id="incidentChart" class="w-full flex-1 pb-5"></canvas>
        </div>

    </div>
</div>


<script>

const incidentAnalysisData = <?= json_encode($incident_analysis); ?>;
const labels = incidentAnalysisData.map(i => i.risk_level || i.department_name);
const totalIncidents = incidentAnalysisData.map(i => i.total_incidents);

new Chart(document.getElementById('incidentChart'), {
    type: 'bar',
    data: {
        labels,
        datasets: [{
            label: 'Total Incidents',
            data: totalIncidents,
            backgroundColor: '#f97316',
            borderColor: '#f97316',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { bottom: 20 } },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Incident Count' } },
            x: { title: { display: true, text: 'Risk Level / Department' }, ticks: { padding: 5 } }
        }
    }
});

const students = <?= json_encode($students_risk_fee); ?>;
const riskScores = [...new Set(students.map(s => s.risk_score))].sort((a, b) => a - b);
const feeAmounts = [...new Set(students.map(s => s.fee_due_amount))].sort((a, b) => a - b);
const maxFee = Math.max(...students.map(s => s.fee_due_amount));
const series = feeAmounts.map(fee => ({
    name: "₹" + fee,
    data: riskScores.map(risk => {
        const s = students.find(s => s.risk_score == risk && s.fee_due_amount == fee);
        return { x: risk, y: fee, student: s?.student_name || "", fillColor: s ? (fee == 0 ? "#93ff93ff" : "#FF4560") : "#FFFFFF" }
    })
}));

const lowHighData = <?= json_encode($lowHigh); ?>;
new ApexCharts(document.querySelector("#myPieChart"), {
    chart: { 
        type: 'pie',
        height: 260   // ✅ controls total space (chart + legend)
    },
    series: lowHighData.map(i => +i["COUNT(*)"]),
    labels: lowHighData.map(i => i.risk_level + " Level"),
    colors: ['#f97316', '#1e35a3', '#dc2626'],
    legend: {
        position: 'bottom',
        horizontalAlign: 'center',
        fontSize: '12px',
        offsetY: -5          // ✅ pulls legend UP inside container
    }
}).render();


const deptData = <?= json_encode($dropout_by_department); ?>;
new Chart(document.getElementById('deptBarChart'), {
    type: 'bar',
    data: {
        labels: deptData.map(d => d.department_name),
        datasets: [{
            label: 'High Risk Students',
            data: deptData.map(d => +d.total),
            backgroundColor: '#1e35a3',
            borderColor: '#1e35a3',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { bottom: 20 } },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Number of Students' } },
            x: { title: { display: true, text: 'Department' }, ticks: { padding: 5 } }
        },
        plugins: { legend: { display: true } }
    }
});


</script>
<!-- <div class="bg-white p-4 rounded shadow mb-10 h-96 md:h-[500px] lg:h-[550px]">
    <div id="heatmap" class="w-full h-full"></div>
</div> -->


<div class="flex flex-col lg:flex-row lg:justify-start lg:items-start p-8 bg-white border rounded-xl mb-10">
    <!-- Chart on the left -->
    <div id="deptChart" class="w-full lg:w-3/4 lg:flex-1" style="padding-top:5px;"></div>

    <!-- Student card on the right -->
    <div class="w-full lg:w-1/3 lg:flex-none lg:ml-4 mt-4 lg:mt-0 h-[550px]" style="box-shadow: rgba(60, 64, 67, 0.3) 0px 1px 2px 0px, rgba(60, 64, 67, 0.15) 0px 2px 6px 2px; border-radius: 10px;">
        <div id="studentCard" class="bg-white/30 backdrop-blur-md border border-white/20 rounded-xl shadow-lg p-4 h-full flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6"> <!-- increased margin -->
                <h3 id="studentCardTitle" class="text-xl font-bold text-[#1e35a3]"></h3>
                <span id="deptFee" class="text-gray-700 font-medium"></span>
            </div>
          <hr border="1" class="border-gray-400 mb-4">
            <!-- Student list / table -->
            <div id="studentList" class="flex flex-col gap-3 max-h-[420px] overflow-y-auto">
                <!-- Example rows -->
                
            </div>
        </div>
    </div>
</div>

<script>
const stackedData = <?= json_encode($stacked_bar) ?>;

// ApexCharts options
const deptOptions = {
    chart: { 
        type: 'bar', 
        height: window.innerWidth < 768 ? 400 : 550,
        stacked: true,
        toolbar: {
    show: false
},

        events: {
            dataPointSelection: function(event, chartContext, config) {
                const dept = stackedData[config.dataPointIndex];
                showStudentCard(dept);
            }
        }
    },
    fill: { opacity: 1 },
    plotOptions: { bar: { horizontal: true, dataLabels: { position: 'center' } } },
    dataLabels: { enabled: true, formatter: v => v, style: { fontSize: '12px', fontWeight: 'bold' } },
    series: [
        { name: 'Paid', data: stackedData.map(d => parseInt(d.paid_count)) },
        { name: 'Unpaid', data: stackedData.map(d => parseInt(d.unpaid_count)) }
    ],
    xaxis: {
        categories: stackedData.map(d => {
            const words = d.department_name.split(' ');
            if (words.length > 1) {
            // Take first letter of each word and make it uppercase
            return words.map(w => w[0].toUpperCase()).join('');
        }
        return d.department_name; // single-word departments stay the same
    
        })
    },
    colors: ['#1e35a3', '#f97316'],
    legend: { position: 'top' },
    title: { text: 'Department wise fees payment status', align: 'left' }
};


const deptChart = new ApexCharts(document.querySelector("#deptChart"), deptOptions);
deptChart.render();

// Show department with max unpaid students on load
const maxUnpaidDept = stackedData.reduce((best, current) => {
    const bestCount = parseInt(best.unpaid_count);
    const currCount = parseInt(current.unpaid_count);
    if (currCount > bestCount) return current;
    if (currCount === bestCount && current.department_name.localeCompare(best.department_name) < 0) return current;
    return best;
});

showStudentCard(maxUnpaidDept);

function showStudentCard(dept) {
    const container = document.getElementById('studentList');
    const title = document.getElementById('studentCardTitle');
    const fee = document.getElementById('deptFee');

    container.innerHTML = '';
    
    // Department name + fee below
    title.innerHTML = `
        <div class="flex flex-col">
            <span class="font-bold text-lg">${dept.department_name}</span>
            <span style="color:#1e35a3; font-weight:600; font-size: 0.875rem;">
                Fee : ₹ ${parseFloat(dept.department_fees_amount).toLocaleString('en-IN', { minimumFractionDigits: 2 })}
            </span>
        </div>
    `;

    // Calculate total uncollected
    const totalUncollected = dept.unpaid_students.reduce(
        (sum, s) => sum + parseFloat(s.amount), 0
    );

    // Total students in dept
    const totalStudents = dept.total_students || (dept.unpaid_students.length + dept.paid_count || 0);

    // Students paid = total - unpaid
    const paidStudentsCount = totalStudents - dept.unpaid_students.length;

    // Total collected = dept fee * paid students
    const totalCollected = dept.department_fees_amount * paidStudentsCount;

    // Collected / Uncollected summary
    fee.innerHTML = `
        <div class="flex flex-col text-right">
            <span class="text-green-600 text-sm font-bold">
                Collected: ₹ ${totalCollected.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
            </span>
            <span class="text-red-600 text-sm">
                Pending: ₹ ${totalUncollected.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
            </span>
        </div>
    `;

    // List of unpaid students
    dept.unpaid_students.forEach(s => {
        const paidAmt = dept.department_fees_amount - s.amount;
        const div = document.createElement('div');
        div.className = "bg-white/50 p-2 rounded-lg flex justify-between items-center shadow-sm";
        div.innerHTML = `
            <div class="flex flex-col">
                <div class="flex items-center space-x-2">
                    <span class="material-symbols-outlined text-red-600">arrow_circle_down</span>
                    <span class="font-bold">${s.name}</span>
                </div>
                <span class="text-green-600 text-sm ml-7">
                    + ₹${paidAmt.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                </span>
            </div>
            <span class="text-red-600 font-bold">
                - ₹ ${parseFloat(s.amount).toLocaleString('en-IN', { minimumFractionDigits: 2 })}
            </span>
        `;
        container.appendChild(div);
    });
}



</script>



<div class="flex flex-col items-center mb-6 mt-30">
    <h2 class="text-xl font-semibold text-center">
       Overall Risk Analysis Table
    </h2>
    <span class="mt-2 h-1 w-16 bg-[#1e35a3] rounded-full"></span>
</div>
<div class="bg-white p-4 rounded-lg shadow-lg border-[#1e35a3] border 1px">
<div class="mb-4">
    <label for="departments" class="mr-2 font-medium">Select Department:</label>
    <select id="departments" class="border rounded px-2 py-1">
        <option value="">All Departments</option>
        <?php foreach($dropout_by_department as $d): ?>
            <option value="<?= esc($d['department_name']) ?>" <?= $d['department_name']==$defaultDept?'selected':'' ?>>
                <?= esc($d['department_name']) ?>
            </option>
        <?php endforeach; ?>
    </select>
</div>


<div class="overflow-x-auto ">
    <table id="riskTable" class="min-w-full border-collapse table-auto text-sm md:text-base">
        <thead class="bg-gray-100">
            <tr>
                <?php foreach(['Student ID','Student Name','Department','Attendance','Internal Marks','Fee Due','Incidents','Risk Score','Risk Level'] as $th): ?>
                    <th class="px-3 py-2 border text-left"><?= $th ?></th>
                <?php endforeach; ?>
            </tr>
        </thead>
        <tbody>
            <?php foreach($predictions as $r): ?>
            <tr class="odd:bg-white even:bg-gray-50">
                <td class="px-3 py-2 border"><?= esc($r['roll_no']) ?></td>
                <td class="px-3 py-2 border"><?= esc($r['student_name']) ?></td>
                <td class="px-3 py-2 border"><?= esc($r['department_name']) ?></td>
                <td class="px-3 py-2 border"><?= intval(esc($r['attendance_percentage'])) ?></td>
                <td class="px-3 py-2 border"><?= intval(esc($r['avg_internal_marks'])) ?></td>
                <td class="px-3 py-2 border"><?= intval(esc($r['fee_due_amount'])) ?></td>
                <td class="px-3 py-2 border"><?= esc($r['incident_count']) ?></td>
                <td class="px-3 py-2 border"><?= esc($r['risk_score']) ?></td>
                <td class="px-3 py-2 border <?= strtolower($r['risk_level']) ?>"><?= esc($r['risk_level']) ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>
</main>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
$(function() {
    const table = $('#riskTable').DataTable({ pageLength: 5,lengthMenu: [5, 10, 25, 50] });
   $('#departments').on('change', () => {
    const dept = $('#departments').val();
    $.post('getStudentsByDept', { department: dept }, res => {
        table.clear();
        res.forEach(r => table.row.add([
            r.roll_no,
            r.student_name,
            r.department_name,
            r.attendance_percentage,
            r.avg_internal_marks,
            r.fee_due_amount,
            r.incident_count,
            r.risk_score,
            `<span class="${r.risk_level.toLowerCase()}">${r.risk_level}</span>`
        ]));
        table.draw();
    }, 'json');
});

            });
</script>
</body>
</html>
